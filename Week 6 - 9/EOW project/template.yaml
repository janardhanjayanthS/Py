AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: "FastAPI RAG Application with Lambda, RDS PostgreSQL with pgvector, and API Gateway"

Parameters:
  EnvironmentName:
    Type: String
    Default: production
    Description: Environment name prefix
    AllowedValues:
      - development
      - staging
      - production

  OpenAIAPIKey:
    Type: String
    NoEcho: true
    Description: OpenAI API Key for LLM operations

  JWTSecretKey:
    Type: String
    NoEcho: true
    Description: Secret key for JWT token generation

  DBMasterUsername:
    Type: String
    Default: postgres
    Description: Master username for PostgreSQL database

  DBMasterPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Master password for PostgreSQL database (minimum 8 characters)

Globals:
  Function:
    Timeout: 900
    MemorySize: 2048
    Runtime: python3.12
    Architectures:
      - x86_64
    Environment:
      Variables:
        ENVIRONMENT: !Ref EnvironmentName
        DB_NAME: vector_db
        DB_USER: !Ref DBMasterUsername
    Tracing: Active

Resources:
  # =====================================================
  # VPC and Networking
  # =====================================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-vpc

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnets
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-public-subnet-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-public-subnet-2

  # Private Subnets
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.11.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-private-subnet-1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.12.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-private-subnet-2

  # NAT Gateway
  NATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AttachGateway
    Properties:
      Domain: vpc

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-nat-gateway

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-public-routes

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-private-routes

  DefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet2

  # =====================================================
  # Security Groups
  # =====================================================
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-lambda-sg

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS PostgreSQL
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-rds-sg

  # =====================================================
  # Secrets Manager
  # =====================================================
  ApplicationSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}-fastapi-secrets
      Description: Secrets for FastAPI RAG application
      SecretString: !Sub |
        {
          "OPENAI_API_KEY": "${OpenAIAPIKey}",
          "JWT_SECRET_KEY": "${JWTSecretKey}",
          "POSTGRESQL_PWD": "${DBMasterPassword}"
        }

  # =====================================================
  # RDS PostgreSQL with pgvector
  # =====================================================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub ${EnvironmentName}-db-subnet-group
      DBSubnetGroupDescription: Subnet group for RDS PostgreSQL
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  DBParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Description: Custom parameter group for PostgreSQL with pgvector
      Family: postgres16
      Parameters:
        shared_preload_libraries: vector

  RDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub ${EnvironmentName}-postgres-db
      Engine: postgres
      EngineVersion: "16.3"
      DBInstanceClass: db.t3.small
      AllocatedStorage: 50
      StorageType: gp3
      StorageEncrypted: true
      MasterUsername: !Ref DBMasterUsername
      MasterUserPassword: !Ref DBMasterPassword
      DBName: vector_db
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBParameterGroupName: !Ref DBParameterGroup
      BackupRetentionPeriod: 7
      PreferredBackupWindow: "03:00-04:00"
      PreferredMaintenanceWindow: "sun:04:00-sun:05:00"
      MultiAZ: false
      PubliclyAccessible: false
      EnableCloudwatchLogsExports:
        - postgresql
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-postgres-db

  # =====================================================
  # S3 Bucket for PDF uploads
  # =====================================================
  PDFUploadBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${EnvironmentName}-pdf-uploads-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  # =====================================================
  # API Gateway
  # =====================================================
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      EndpointConfiguration: REGIONAL
      Cors:
        AllowMethods: "'GET,POST,OPTIONS,PUT,DELETE'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"

  # =====================================================
  # Lambda Execution Role
  # =====================================================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-lambda-execution-role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref ApplicationSecrets
        - PolicyName: S3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt PDFUploadBucket.Arn
                  - !Sub ${PDFUploadBucket.Arn}/*
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*

  # =====================================================
  # Lambda Functions
  # =====================================================

  # Main API Function Log Group
  MainAPILogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${EnvironmentName}-MainAPIFunction
      RetentionInDays: 7

  # Main API Function (handles /, /health)
  MainAPIFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${EnvironmentName}-MainAPIFunction
      Role: !GetAtt LambdaExecutionRole.Arn
      PackageType: Image
      LoggingConfig:
        LogGroup: !Ref MainAPILogGroup
      Environment:
        Variables:
          DB_HOST: !GetAtt RDSInstance.Endpoint.Address
          DB_PORT: !GetAtt RDSInstance.Endpoint.Port
          S3_BUCKET: !Ref PDFUploadBucket
          SECRET_NAME: !Ref ApplicationSecrets
      VpcConfig:
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
      Events:
        RootPath:
          Type: Api
          Properties:
            Path: /
            Method: GET
            RestApiId: !Ref ApiGateway
        HealthCheck:
          Type: Api
          Properties:
            Path: /health
            Method: GET
            RestApiId: !Ref ApiGateway
      Tags:
        Function: MainAPIFunction
    Metadata:
      Dockerfile: Dockerfile
      DockerContext: .
      DockerTag: python3.12-v1

  # AI Query Function Log Group
  AIQueryLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${EnvironmentName}-AIQueryFunction
      RetentionInDays: 7

  # AI Query Function
  AIQueryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${EnvironmentName}-AIQueryFunction
      Role: !GetAtt LambdaExecutionRole.Arn
      PackageType: Image
      LoggingConfig:
        LogGroup: !Ref AIQueryLogGroup
      Environment:
        Variables:
          DB_HOST: !GetAtt RDSInstance.Endpoint.Address
          DB_PORT: !GetAtt RDSInstance.Endpoint.Port
          S3_BUCKET: !Ref PDFUploadBucket
          SECRET_NAME: !Ref ApplicationSecrets
      VpcConfig:
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
      Events:
        AIQuery:
          Type: Api
          Properties:
            Path: /ai/query
            Method: POST
            RestApiId: !Ref ApiGateway
      Tags:
        Function: AIQueryFunction
    Metadata:
      Dockerfile: Dockerfile
      DockerContext: .
      DockerTag: python3.12-v1

  # Chat Function Log Group
  ChatLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${EnvironmentName}-ChatFunction
      RetentionInDays: 7

  # Chat Function
  ChatFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${EnvironmentName}-ChatFunction
      Role: !GetAtt LambdaExecutionRole.Arn
      PackageType: Image
      LoggingConfig:
        LogGroup: !Ref ChatLogGroup
      Environment:
        Variables:
          DB_HOST: !GetAtt RDSInstance.Endpoint.Address
          DB_PORT: !GetAtt RDSInstance.Endpoint.Port
          S3_BUCKET: !Ref PDFUploadBucket
          SECRET_NAME: !Ref ApplicationSecrets
      VpcConfig:
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
      Events:
        Chat:
          Type: Api
          Properties:
            Path: /chat
            Method: POST
            RestApiId: !Ref ApiGateway
      Tags:
        Function: ChatFunction
    Metadata:
      Dockerfile: Dockerfile
      DockerContext: .
      DockerTag: python3.12-v1

  # User Register Function Log Group
  UserRegisterLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${EnvironmentName}-UserRegisterFunction
      RetentionInDays: 7

  # User Register Function
  UserRegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${EnvironmentName}-UserRegisterFunction
      Role: !GetAtt LambdaExecutionRole.Arn
      PackageType: Image
      LoggingConfig:
        LogGroup: !Ref UserRegisterLogGroup
      Environment:
        Variables:
          DB_HOST: !GetAtt RDSInstance.Endpoint.Address
          DB_PORT: !GetAtt RDSInstance.Endpoint.Port
          S3_BUCKET: !Ref PDFUploadBucket
          SECRET_NAME: !Ref ApplicationSecrets
      VpcConfig:
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
      Events:
        Register:
          Type: Api
          Properties:
            Path: /user/register
            Method: POST
            RestApiId: !Ref ApiGateway
      Tags:
        Function: UserRegisterFunction
    Metadata:
      Dockerfile: Dockerfile
      DockerContext: .
      DockerTag: python3.12-v1

  # User Login Function Log Group
  UserLoginLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${EnvironmentName}-UserLoginFunction
      RetentionInDays: 7

  # User Login Function
  UserLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${EnvironmentName}-UserLoginFunction
      Role: !GetAtt LambdaExecutionRole.Arn
      PackageType: Image
      LoggingConfig:
        LogGroup: !Ref UserLoginLogGroup
      Environment:
        Variables:
          DB_HOST: !GetAtt RDSInstance.Endpoint.Address
          DB_PORT: !GetAtt RDSInstance.Endpoint.Port
          S3_BUCKET: !Ref PDFUploadBucket
          SECRET_NAME: !Ref ApplicationSecrets
      VpcConfig:
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
      Events:
        Login:
          Type: Api
          Properties:
            Path: /user/login
            Method: POST
            RestApiId: !Ref ApiGateway
      Tags:
        Function: UserLoginFunction
    Metadata:
      Dockerfile: Dockerfile
      DockerContext: .
      DockerTag: python3.12-v1

  # Upload PDF Function Log Group
  UploadPDFLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${EnvironmentName}-UploadPDFFunction
      RetentionInDays: 7

  # Upload PDF Function
  UploadPDFFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${EnvironmentName}-UploadPDFFunction
      Role: !GetAtt LambdaExecutionRole.Arn
      PackageType: Image
      LoggingConfig:
        LogGroup: !Ref UploadPDFLogGroup
      Environment:
        Variables:
          DB_HOST: !GetAtt RDSInstance.Endpoint.Address
          DB_PORT: !GetAtt RDSInstance.Endpoint.Port
          S3_BUCKET: !Ref PDFUploadBucket
          SECRET_NAME: !Ref ApplicationSecrets
      VpcConfig:
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
      Events:
        UploadPDF:
          Type: Api
          Properties:
            Path: /data/upload_pdf
            Method: POST
            RestApiId: !Ref ApiGateway
      Tags:
        Function: UploadPDFFunction
    Metadata:
      Dockerfile: Dockerfile
      DockerContext: .
      DockerTag: python3.12-v1

  # Upload Web Content Function Log Group
  UploadWebLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${EnvironmentName}-UploadWebFunction
      RetentionInDays: 7

  # Upload Web Content Function
  UploadWebFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${EnvironmentName}-UploadWebFunction
      Role: !GetAtt LambdaExecutionRole.Arn
      PackageType: Image
      LoggingConfig:
        LogGroup: !Ref UploadWebLogGroup
      Environment:
        Variables:
          DB_HOST: !GetAtt RDSInstance.Endpoint.Address
          DB_PORT: !GetAtt RDSInstance.Endpoint.Port
          S3_BUCKET: !Ref PDFUploadBucket
          SECRET_NAME: !Ref ApplicationSecrets
      VpcConfig:
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
      Events:
        UploadWeb:
          Type: Api
          Properties:
            Path: /data/upload_web_content
            Method: POST
            RestApiId: !Ref ApiGateway
      Tags:
        Function: UploadWebFunction
    Metadata:
      Dockerfile: Dockerfile
      DockerContext: .
      DockerTag: python3.12-v1

Outputs:
  ApiGatewayURL:
    Description: API Gateway endpoint URL
    Value: !Sub https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/Prod/
    Export:
      Name: !Sub ${EnvironmentName}-api-url

  RDSEndpoint:
    Description: RDS PostgreSQL Endpoint
    Value: !GetAtt RDSInstance.Endpoint.Address
    Export:
      Name: !Sub ${EnvironmentName}-rds-endpoint

  S3BucketName:
    Description: S3 Bucket for PDF uploads
    Value: !Ref PDFUploadBucket
    Export:
      Name: !Sub ${EnvironmentName}-s3-bucket

  SecretsManagerARN:
    Description: Secrets Manager ARN
    Value: !Ref ApplicationSecrets
    Export:
      Name: !Sub ${EnvironmentName}-secrets-arn
